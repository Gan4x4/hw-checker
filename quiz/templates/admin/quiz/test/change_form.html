{% extends "admin/change_form.html" %}
{% load i18n %}

{% block extrahead %}
    {{ block.super }}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const inlineTable = document.querySelector(".inline-group table");
            if (!inlineTable) {
                return;
            }

            const tbody = inlineTable.querySelector("tbody");
            if (!tbody) {
                return;
            }

            const collator = new Intl.Collator(undefined, {numeric: true, sensitivity: "base"});

            const getRows = () => Array.from(tbody.querySelectorAll("tr")).filter(
                (row) => !row.classList.contains("add-row")
            );

            const getCellValue = (row, index) => {
                const cell = row.children[index];
                if (!cell) {
                    return "";
                }
                return (cell.textContent || "").trim().toLowerCase();
            };

            inlineTable.querySelectorAll("thead th").forEach((header, index) => {
                const label = (header.textContent || "").trim();
                if (!label || /delete/i.test(label)) {
                    return;
                }
                header.style.cursor = "pointer";
                header.addEventListener("click", function () {
                    const current = header.dataset.sortDir === "asc" ? "desc" : "asc";
                    header.dataset.sortDir = current;
                    getRows()
                        .sort((a, b) => {
                            const result = collator.compare(
                                getCellValue(a, index),
                                getCellValue(b, index)
                            );
                            return current === "asc" ? result : -result;
                        })
                        .forEach((row) => tbody.insertBefore(row, tbody.querySelector(".add-row") || null));
                });
            });
        });
    </script>
{% endblock %}

{% block submit_buttons_top %}
    {% if not view_only %}
        {% if has_quizzes %}
            <button type="submit" name="_export_links" value="1" formnovalidate class="button">{% trans "Export quiz links" %}</button>
        {% endif %}
        {% if can_reset %}
            <button type="submit" name="_reset_test" value="1" formnovalidate class="button">{% trans "Reset test" %}</button>
        {% endif %}
        {% if can_start %}
            <button type="submit" name="_start_test" value="1" formnovalidate class="button default">{% trans "Start test" %}</button>
        {% endif %}
        {{ block.super }}
    {% endif %}
{% endblock %}

{% block submit_buttons_bottom %}
    {% if not view_only %}
        {% if has_quizzes %}
            <button type="submit" name="_export_links" value="1" formnovalidate class="button">{% trans "Export quiz links" %}</button>
        {% endif %}
        {% if can_reset %}
            <button type="submit" name="_reset_test" value="1" formnovalidate class="button">{% trans "Reset test" %}</button>
        {% endif %}
        {% if can_start %}
            <button type="submit" name="_start_test" value="1" formnovalidate class="button default">{% trans "Start test" %}</button>
        {% endif %}
        {{ block.super }}
    {% endif %}
{% endblock %}

{% block after_field_sets %}
    {{ block.super }}
    {% if original %}
        <div class="inline-group" style="margin-top: 1rem;">
            <fieldset class="module">
                <h2>{% trans "Quizzes" %}</h2>
                <p class="help">{% trans "This table mirrors the Quiz list filtered to this test." %}</p>
                {% include "admin/quiz/quizlink/quiz_list_table.html" with quizzes=quizzes %}
            </fieldset>
        </div>
    {% elif not has_quizzes %}
        <div class="inline-group" style="margin-top: 1rem;">
            <fieldset class="module">
                <h2>{% trans "No quizzes assigned" %}</h2>
                <p>{% trans "Add quizzes to this test from the Quiz list using the Make test action." %}</p>
            </fieldset>
        </div>
    {% endif %}
    {% if is_active %}
        <div class="inline-group" style="margin-top: 1rem;">
            <fieldset class="module">
                <h2>{% trans "Active test" %}</h2>
                <p>
                    {% blocktrans %}This test is active. Remaining time: {{ remaining_seconds }} seconds.{% endblocktrans %}
                </p>
            </fieldset>
        </div>
    {% endif %}
    {% if show_import_form and not view_only %}
        <div class="inline-group" style="margin-top: 1rem;">
            <fieldset class="module">
                <h2>{% trans "Import question files" %}</h2>
                <div class="form-row">
                    <label for="id_json_files">{% trans "JSON files" %}</label>
                    <input type="file" id="id_json_files" name="json_files" multiple>
                </div>
                <p class="help">{% trans "Upload one or more JSON files â€“ the student is detected from the file name." %}</p>
                <button type="submit" name="_import_questions" value="1" formnovalidate class="button">{% trans "Import files" %}</button>
            </fieldset>
        </div>
    {% endif %}
{% endblock %}
